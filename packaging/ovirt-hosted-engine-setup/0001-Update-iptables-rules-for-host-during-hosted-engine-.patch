From a79e22a4dd31d4f1b8ec528dbcacdf6965f79288 Mon Sep 17 00:00:00 2001
From: root <root@osbuild.eayun.com>
Date: Sat, 28 May 2016 10:31:51 -0400
Subject: [PATCH] Update iptables rules for host during hosted engine setup

Signed-off-by: Pan Liyang <liyang.pan@eayun.com>
---
 templates/iptables.default.in | 26 ++++++++++++++++++++------
 1 file changed, 20 insertions(+), 6 deletions(-)

diff --git a/templates/iptables.default.in b/templates/iptables.default.in
index 5cb4682..01b046c 100644
--- a/templates/iptables.default.in
+++ b/templates/iptables.default.in
@@ -1,14 +1,28 @@
 # Generated by ovirt-hosted-engine-setup installer
-#filtering rules
 *filter
 :INPUT ACCEPT [0:0]
 :FORWARD ACCEPT [0:0]
 :OUTPUT ACCEPT [0:0]
+-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
+-A INPUT -p icmp -j ACCEPT
 -A INPUT -i lo -j ACCEPT
--A INPUT -p icmp -m icmp --icmp-type any -j ACCEPT
--A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
--A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-@CUSTOM_RULES@
-#drop all rule
+# vdsm
+-A INPUT -p tcp --dport @VDSM_PORT@ -j ACCEPT
+# libvirt tls
+-A INPUT -p tcp --dport 16514 -j ACCEPT
+# SSH
+-A INPUT -p tcp --dport @SSH_PORT@ -j ACCEPT
+# guest consoles
+-A INPUT -p tcp -m multiport --dports 5900:6923 -j ACCEPT
+# migration
+-A INPUT -p tcp -m multiport --dports 49152:49216 -j ACCEPT
+# snmp
+-A INPUT -p udp --dport 161 -j ACCEPT
+# ovirt-imageio-daemon
+-A INPUT -p tcp --dport 54322 -j ACCEPT
+# neutron gre mode
+-A INPUT -p gre -j ACCEPT
+# Reject any other input traffic
 -A INPUT -j REJECT --reject-with icmp-host-prohibited
+-A FORWARD -m physdev ! --physdev-is-bridged -j REJECT --reject-with icmp-host-prohibited
 COMMIT
-- 
1.8.3.1

